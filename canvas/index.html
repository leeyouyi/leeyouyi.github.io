<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>

<style>
    *{
        padding: 0;
        margin: 0;
    }
    .content{
        width: 100vw;
        display: flex;
        /* margin-top: 20px; */
    }
    .inputBox{
        width: 180px;
        padding: 30px;
    }
    input{
        width: 150px;
        height: 50px;
        margin-bottom: 15px;
    }
    #numAry{
        font-size: 16px;
        color:#f00;
    }
    button{
        width: 120px;
        height: 50px;
        margin: 0px 10px;
        margin-top: 30px;

    }
</style>
<body>
    <div class="content"> 

        <div id="canvas"></div>


        <div class="inputBox" id="inputBox">
            <div class="input">
                <label for="input1">號碼1</label>
                <input id="input1" type="text" />
            </div>  
            <div class="input">
                <label for="input2">號碼2</label>
                <input id="input2" type="text" />
            </div>  
            <div class="input">
                <label for="input3">號碼3</label>
                <input id="input3" type="text" />
            </div>  
            <div class="input">
                <label for="input4">號碼4</label>
                <input id="input4" type="text" />
            </div>  
            <div class="input">
                <label for="input5">號碼5</label>
                <input id="input5" type="text" />
            </div>  
            <div class="input">
                <label for="input6">號碼6</label>
                <input id="input6" type="text" />
            </div>  
            <div class="input">
                <label for="input7">號碼7</label>
                <input id="input7" type="text" />
            </div>

            <div>
                <p>已輸入號碼 : </p>
                <p id="numAry"></p>
            </div>

            <button id="btn">重新開獎</button>

        </div>


    </div>

    <script>
    (function(){
        // 4096*2304
        // 1920*1080
        //2.844
        //0.3515625
        let configWith = 1440;
        let configHeight = 810;
        var config = {
            type: Phaser.AUTO,
            width: configWith,
            height: configHeight,
            parent: "canvas",
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 200 }
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var game = new Phaser.Game(config);
        var curve = [] 
        var graphics =[]
        var path =[]
        var inputAry = []
        var _this 
        var end = true
        var nextNum = 1
        var inputValue = [] //實際號碼
        var rotation = false
        var newAry= []
        var sortAry = []
        var text1
        var text2


        document.querySelector('#btn').addEventListener('click',()=>{
            location.reload()
        })

        function getDegree(x1, y1, x2, y2) {
            var x = Math.abs(x1 - x2);
            var y = Math.abs(y1 - y2);
            var z = Math.sqrt(x * x + y * y);
            return Math.round((Math.asin(y / z) / Math.PI * 180));
        }

        function preload ()
        {
            
            this.load.image('Panel', './assets/Panel.png')
            for (let i = 1; i <= 49; i++) {
                let num = i < 10 ?  '0' + i :  ''+ i
                this.load.image(`ball${i}`, `./assets/Ball/${num}.png`)
            }
            
        }



        function create ()
        {  

            text1 = this.add.text(10, 10, '', { fill: '#00ff00' })
            text2 = this.add.text(500, 10, '', { fill: '#00ff00' })

            _this = this
            this.num = 0
            this.ball = []
            this.panel =  this.add.image(682 , 600, `Panel`).setScale(.35).setDepth(1)

            this.Z = .35
            this.Y = true
            // console.log(this.panel)


            var inputBox = document.querySelector("#inputBox")
            inputBox.querySelectorAll('input').forEach((item,index)=>{
                item.addEventListener("keydown", ({key}) => {
                    if (key === "Enter"){
                        // console.log('keydonw',index)
                        let value =  item.value
                        let hasValue = inputValue.indexOf(value)
                        if(value === '') return
                        if(isNaN(Number(value))) return
                        if( Number(value) <= 0  || (Number(value) > 49) ) return
                        if(hasValue !== -1) return
                        if(end && (nextNum === index + 1)){
                            // console.log(hasValue)
                            inputValue.push(value)
                            start(index + 1, value)
                            this.num = index + 1
                            nextNum = nextNum + 1
                            // console.log(inputValue)
                            document.querySelector('#numAry').innerText = inputValue
                        }
                    
                    } 
                })
            })


            for (let i = 0; i < 8; i++) {
                inputAry[i] = true
                
            }


        }
        

        function start(i,num){

            if(inputAry[i]){
                
                let distance = i < 7 ? (i -1)* 123 :  (i-1)* 123 + 20 

                var points = [ 100 + distance, 900, 220 + distance, 500, 300 + distance, 600  ];
                var curve = new Phaser.Curves.Spline(points);

                var startPoint = new Phaser.Math.Vector2(100 + distance, 900);
                // var controlPoint1 = new Phaser.Math.Vector2(130 + distance, 520);
                // var controlPoint2 = new Phaser.Math.Vector2(300 + distance, 450);
                // var endPoint = new Phaser.Math.Vector2(300 + distance, 600);
                // var curve = new Phaser.Curves.CubicBezier(startPoint, controlPoint1, controlPoint2, endPoint);

                _this.ball[i] = _this.add.follower(curve, 100 + distance, 900, `ball${num}`).setScale(.36).setDepth(2)
                _this.ball[i].startFollow({
                    duration: 1500,
                    onStart:(()=>{
                        console.log('start')
                        _this.ball[i].setScale(1.5)
                    }),
                    onUpdate:(()=>{
                        let num = _this.ball[i]._scaleX
                        num = num -0.013
                        if(num <= 0.36) num = 0.36
                        _this.ball[i].setScale(num)
                    }),
                    onComplete:(()=>{
                        _this.ball[i].setScale(.36)
                    })
                });
 

    
                // _this.ball[i] =  _this.add.image(200 + distance ,  900, `ball${num}`).setScale(.36).setDepth(2)
                // _this.tween = _this.tweens.add({
                // targets: _this.ball[i],
                // props: {
                //     x: { value: 300 + distance , duration: 1000, flipX: false },
                //     y: { value: 600, duration: 1000,  },
                // },
                //     ease: 'Power1',
                //     onStart:(()=>{
                //         console.log('start')
                //         // _this.ball[i].setScale(.90)
                //     }),
                //     onUpdate:(()=>{
                //         // let num = _this.ball[i]._scaleX
                //         // num = num -0.001
                //         // if(num <= 0.7) num = 0.7
                //         // _this.ball[i].setScale(num)
                //     }),
                //     onComplete:(()=>{

                //     })
                // })

                inputAry[i] = false

                if(i === 7){
                    setTimeout(()=>{
                         newAry = inputValue.map(item=>{
                            return item
                        })
                        newAry.splice(6,1)
                        newAry.sort((a,b)=>{
                            return a-b
                        })
                        newAry.push(inputValue[6])
                        setTimeout(()=>{
                            rotation = true
                            newAry.forEach((el,index)=>{
                                sortAry[index] =  _this.add.image( _this.ball[ index + 1].x  , _this.ball[ index + 1].y, `ball${el}`).setScale(.36).setDepth(0)
                            })
     
                        },1000)

                    },2000)
                }
            }


        }


        function update ()
        {
            var pointer = this.input.activePointer;

            text1.setText([
                'x: ' + pointer.worldX,
                'y: ' + pointer.worldY,
                // 'isDown: ' + pointer.isDown
            ])

            if(rotation){

                if(this.Y){
                    this.panel.setScale(.35, this.Z) 
                    
                    inputValue.forEach((el,i)=>{
                        _this.ball[i + 1].setPosition(_this.ball[i + 1].x+ this.Z / 4, _this.ball[i + 1].y + this.Z * 3  )
                    })
                    sortAry.forEach((el,i)=>{
                        el.setPosition(el.x - this.Z / 4 , el.y - this.Z * 3 )
                    })
                    
                    this.Z -= .005;
                    if(this.Z <= 0) {
                        sortAry.forEach((el,i)=>{
                            el.setDepth(2)
                        })
                        this.Y =false
                    }

                }
                if(!this.Y){
                    if(this.Z >= .35 ) return
                    this.Z += .005
                    this.panel.setScale(.35, this.Z) 
                    inputValue.forEach((el,i)=>{
                        _this.ball[i + 1].setPosition(_this.ball[i + 1].x - this.Z / 4, _this.ball[i + 1].y - this.Z * 3  ).setDepth(0)
                    })
                    sortAry.forEach((el,i)=>{
                        el.setPosition(el.x + this.Z / 4, el.y + this.Z * 3  )
                    })
                }

            }





        }

        })()


    </script>

</body>
</html>